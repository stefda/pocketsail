function Label(a,b,c,d,e,f,h,g,l){this.id=a;this.url=b;this.text=c;this.cat=d;this.sub=e;this.latLng=f;this.getFirstShape=function(){return this.isVisible()?g[0]:null};this.getFirstType=function(){var a=this.getFirstShape();return null===a?h.getFirstType():a.getType()};this.hasBoundIcon=function(){var a=this.getFirstShape();return null===a?!1:a.getType().match(/[R|L|T|B|I]/)};this.hasFreeIcon=function(){var a=this.getFirstShape();return null===a?!1:"F"===a.getType()};this.hasText=function(){var a=
this.getFirstShape();return null===a?!1:a.getType().match(/[R|L|T|B|X]/)};this.getIconStyle=function(){return this.hasBoundIcon()?h.getBoundIconStyle():this.hasFreeIcon()?h.getFreeIconStyle():null};this.getDescriptor=function(){return h};this.getShapes=function(){return g};this.canOverlap=function(){return 0<g.length&&"F"!==g[0].getType()};this.isVisible=function(){return 0<g.length};this.getBShape=function(){return l};this.intrudes=function(a){a=a.getBShape();return null===l||null===a?!1:a.overlaps(l)};
this.eliminateOverlaps=function(a){var c=this.getFirstShape();a=a.getShapes();if(null!==c&&"F"!==c.getType())for(var b=0;b<a.length;b++){var d=a[b];"F"!==d.getType()&&c.overlaps(d)&&a.splice(b--,1)}}}
Label.deserialize=function(a,b){var c=a.id,d=a.text,e=a.url,f=a.cat,h=a.sub,g=LatLng.fromGeoJson(a.latLng),l=LabelDescriptor.fromString(a.desc);if("static"===a.type){var k=LabelShape.buildShapes(l);return new Label(c,e,d,f,h,g,l,k,null)}for(var k=Proj.latlng2pixel(g,b),k=LabelShape.buildShapes(l,d,k),m=LabelShape.buildBShape(k),n=256*Math.pow(2,b),p=0;p<k.length;p++)k[p].wrapAroundPlane(n);m.wrapAroundPlane(n);return new Label(c,e,d,f,h,g,l,k,m)};function LabelBBox(a,b,c,d){this.top=a;this.right=b;this.bottom=c;this.left=d;this.overlaps=function(a){return a.top<this.bottom&&a.bottom>this.top&&a.right>this.left&&a.left<this.right}};function IconStyle(a,b,c,d){this.type=a;this.size=b;this.imageLeftOffset=c;this.imageRightOffset=d;this.getPixelWidth=function(){return IconStyle.Size[this.size]}}IconStyle.Type={BOUND:1,FREE:2};IconStyle.Size={o:10,s:16,m:20,l:22,x:24};function TextStyle(a,b,c){this.size=a;this.weight=b;this.style=c;this.getPixelSize=function(){return TextStyle.Size[this.size]}}TextStyle.Size={s:9,m:11,l:13};TextStyle.SizeFactor={n:{s:4.5,m:5,l:6.1},b:{s:5.2,m:6.3,l:8.1}};
function LabelDescriptor(a,b,c,d,e,f){this.getPadding=function(){return a};this.getSpacing=function(){return b};this.getTypes=function(){return c};this.getFirstType=function(){return c[0]};this.getIconStyle=function(){return this.hasBoundIcon()?d:e};this.getBoundIconStyle=function(){return d};this.getFreeIconStyle=function(){return e};this.hasBoundIcon=function(){return null!==d};this.hasFreeIcon=function(){return null!==e};this.hasText=function(){return null!==f};this.getBoundIconPixelWidth=function(){return null===
d?0:d.getPixelWidth()};this.getBoundIconImageLeftOffset=function(){return null===d?0:d.imageLeftOffset};this.getBoundIconImageRightOffset=function(){return null===d?0:d.imageRightOffset};this.getFreeIconPixelWidth=function(){return null===e?0:e.getPixelWidth()};this.getFreeIconImageLeftOffset=function(){return null===e?0:e.imageLeftOffset};this.getFreeIconImageRightOffset=function(){return null===e?0:e.imageRightOffset};this.getTextSize=function(){return null===f?"":f.size};this.getTextPixelSize=
function(){return null===f?0:f.getPixelSize()};this.getTextWeight=function(){return null===f?"":f.weight};this.getTextStyle=function(){return null===f?"":f.style}}
LabelDescriptor.fromString=function(a){a=/^L((-?\d+)(,(-?\d+))?)?([R|L|T|B|X|I|F]{1,7})(i([o|s|m|l|x])(-?\d+),(-?\d+))?(f([o|s|m|l|x])(-?\d+),(-?\d+))?(t([s|m|l])([n|b])([n|i]))?$/.exec(a);if(null===a)return null;var b=null,c=null,d=null,e=void 0===a[2]?0:parseInt(a[2]),f=void 0===a[4]?0:parseInt(a[4]),h=a[5];if(void 0!==a[6])var g=a[7].charAt(0),l=parseInt(a[8]),k=parseInt(a[9]),b=new IconStyle(IconStyle.Type.BOUND,g,l,k);void 0!==a[10]&&(g=a[11].charAt(0),l=parseInt(a[12]),k=parseInt(a[13]),c=new IconStyle(IconStyle.Type.FREE,
g,l,k));void 0!==a[14]&&(g=a[15],d=new TextStyle(g,a[16],a[17]));return new LabelDescriptor(e,f,h,b,c,d)};function Labeller(){}Labeller.doLabelling=function(a){for(var b=0;b<a.length-1;b++)if(a[b].important=!0,a[b].canOverlap())for(var c=b+1;c<a.length;c++)a[c].intrudes(a[b])&&a[c].canOverlap()&&(a[b].eliminateOverlaps(a[c]),a[c].isVisible()||a.splice(c--,1));a[a.length-1].important=!0};function LabellerUtils(){}LabellerUtils.computeRoughTextWidth=function(a,b,c,d,e){return a.length*TextStyle.SizeFactor[d][c]};function LabelShape(a,b){this.bboxes=b;this.getType=function(){return a};this.isFree=function(){return"F"===a};this.getBBoxes=function(){return b};this.wrapAroundPlane=function(a){for(var d=[],e=0;e<b.length;e++){var f=b[e];if(0>f.left||f.right>a)0>f.left&&d.push(new LabelBBox(f.top,a,f.bottom,a+f.left)),f.right>a&&d.push(new LabelBBox(f.top,f.right-a,f.bottom,0))}for(e=0;e<d.length;e++)b.push(d[e])};this.overlaps=function(a){for(var d=0;d<b.length;d++)for(var e=b[d],f=0;f<a.bboxes.length;f++)if(e.overlaps(a.bboxes[f]))return!0;
return!1};this.toBBox=function(){if(0===b.length)return null;for(var a=new LabelBBox(b[0].top,b[0].right,b[0].bottom,b[0].left),d=1;d<b.length;d++)a.top=Math.min(a.top,b[d].top),a.right=Math.max(a.right,b[d].right),a.bottom=Math.max(a.bottom,b[d].bottom),a.left=Math.min(a.left,b[d].left);return a}}LabelShape.computeTextWidthFx=LabellerUtils.computeRoughTextWidth;
LabelShape.buildBShape=function(a){if(0===a.length||a[0].isFree())return null;for(var b=a[0].toBBox(),c=1;c<a.length;c++){var d=a[c].toBBox();b.top=Math.min(b.top,d.top);b.right=Math.max(b.right,d.right);b.bottom=Math.max(b.bottom,d.bottom);b.left=Math.min(b.left,d.left)}return new LabelShape("",[b])};
LabelShape.buildShapes=function(a,b,c){var d=[];if(1===arguments.length)return d.push(new LabelShape(a.getFirstType()),[]),d;var e=0,f=0,h=0,g=e=0,l=0,k=c.x(),m=c.y(),n=a.getPadding(),p=a.getSpacing();a.hasBoundIcon()&&(e=a.getBoundIconPixelWidth(),e=Math.ceil(e/2));a.hasText()&&(h=a.getTextPixelSize(),f=Math.round(LabelShape.computeTextWidthFx(b,"Arial",a.getTextSize(),a.getTextWeight(),a.getTextStyle())),l=Math.ceil(h/2),g=Math.ceil(f/2));for(var r=a.getTypes().split(""),q=0;q<r.length;q++)switch(r[q]){case "F":d.push(LabelShape.buildFreeIconShape(k,
m,e));break;case "I":d.push(LabelShape.buildIconOnlyShape(k,m,a.getPadding(),e));break;case "X":d.push(LabelShape.buildTextOnlyShape(k,m,n,l,g));break;case "R":d.push(LabelShape.buildTextRightShape(k,m,n,p,e,l,f));break;case "L":d.push(LabelShape.buildTextLeftShape(k,m,n,p,e,l,f));break;case "T":d.push(LabelShape.buildTextTopShape(k,m,n,p,e,h,g));break;case "B":d.push(LabelShape.buildTextBottomShape(k,m,n,p,e,h,g))}return d};
LabelShape.buildFreeIconShape=function(a,b,c){var d=[];d.push(new LabelBBox(b-c,a+c,b+c,a-c));return new LabelShape("F",d)};LabelShape.buildIconOnlyShape=function(a,b,c,d){var e=[];e.push(new LabelBBox(b-d-c,a+d+c,b+d+c,a-d-c));return new LabelShape("I",e)};LabelShape.buildTextOnlyShape=function(a,b,c,d,e){var f=[];f.push(new LabelBBox(b-d-c,a+e+c,b+d+c,a-e-c));return new LabelShape("X",f)};
LabelShape.buildTextRightShape=function(a,b,c,d,e,f,h){var g=[];g.push(new LabelBBox(b-e-c,a+e+c,b+e+c,a-e-c));g.push(new LabelBBox(b-f-c,a+e+d+h+c,b+f+c,a+e+d-c));return new LabelShape("R",g)};LabelShape.buildTextLeftShape=function(a,b,c,d,e,f,h){var g=[];g.push(new LabelBBox(b-e-c,a+e+c,b+e+c,a-e-c));g.push(new LabelBBox(b-f-c,a-e-d+c,b+f+c,a-e-d-h-c));return new LabelShape("L",g)};
LabelShape.buildTextTopShape=function(a,b,c,d,e,f,h){var g=[];g.push(new LabelBBox(b-e-c,a+e+c,b+e+c,a-e-d));g.push(new LabelBBox(b-e-d-f-c,a+h+c,b-e-d+c,a-h-c));return new LabelShape("T",g)};LabelShape.buildTextBottomShape=function(a,b,c,d,e,f,h){var g=[];g.push(new LabelBBox(b-e-c,a+e+c,b+e+c,a-e-c));g.push(new LabelBBox(b+e+d-c,a+h+c,b+e+d+f+c,a-h-c));return new LabelShape("B",g)};function Marker(a){this.psMap=a.map;this.map=a.map._map;this.label=a.label;this.url=a.label.url;this.id=this.label.id;this.text=a.label.text;this.latLng=this.label.latLng.toGoogleLatLng();this.desc=a.label.getDescriptor();this.div_=null;this.setMap(this.map)}Marker.prototype=new google.maps.OverlayView;
Marker.prototype.onAdd=function(){this.div_=document.createElement("div");this.div_.style.position="absolute";this.div_.className="label "+this.label.sub;this.getPanes().floatPane.appendChild(this.div_);this.label.important&&(this.div_.className+=" important");this.label.hasText()&&this.buildText();(this.label.hasBoundIcon()||this.label.hasFreeIcon())&&this.buildIcon();var a=this;google.maps.event.addDomListener(this.div_,"contextmenu",function(b){var c=a.psMap.canvas.offset(),c={client:{x:b.clientX,
y:b.clientY},pixel:{x:b.clientX-c.left,y:b.clientY-c.top}};if("marker_contextmenu"in a.psMap.onCallbacks)for(var d=a.psMap.onCallbacks.marker_contextmenu,e=0;e<d.length;e++)d[e].call(a.map,a,c),b.preventDefault()});google.maps.event.addDomListener(this.div_,"click",function(b){var c=a.psMap.canvas.offset(),c={client:{x:b.clientX,y:b.clientY},pixel:{x:b.clientX-c.left,y:b.clientY-c.top}};if("marker_click"in a.psMap.onCallbacks)for(var d=a.psMap.onCallbacks.marker_click,e=0;e<d.length;e++)d[e].call(a.map,
a,c),b.preventDefault()})};Marker.prototype.draw=function(){var a=this.getProjection().fromLatLngToDivPixel(this.latLng);this.div_.style.top=a.y+"px";this.div_.style.left=a.x+"px"};Marker.prototype.onRemove=function(){this.div_.parentNode.removeChild(this.div_);this.div_=null};
Marker.prototype.buildIcon=function(){var a=document.createElement("div"),b=this.label.getIconStyle(),c=b.getPixelWidth(),d=Math.floor(c/2),e=b.imageLeftOffset,b=b.imageRightOffset;a.className="icon"+(this.label.hasFreeIcon()?" p":"");a.style.position="absolute";a.style.width=c+"px";a.style.height=c+"px";a.style.top=-d+"px";a.style.left=-d+"px";a.style.backgroundPosition=e+"px "+b+"px";this.div_.appendChild(a)};
Marker.prototype.buildText=function(){var a=document.createElement("div"),b=null,c=this.label.getFirstType(),d=this.desc.getTextPixelSize(),b=this.desc.getBoundIconPixelWidth(),e=Math.floor(d/2),f=Math.floor(b/2),h=this.desc.getSpacing();a.className="text";a.innerHTML=this.text;a.style.position="absolute";a.style.fontSize=d+"px";a.style.lineHeight=d+"px";a.style.fontWeight="b"===this.desc.getTextWeight()?"bold":"";a.style.fontStyle="i"===this.desc.getTextStyle()?"italic":"";"X"===c||"T"===c||"B"===
c?(b=document.createElement("div"),b.className="textWrapper",b.style.position="relative",b.appendChild(a),a.style.position="relative",a.style.left="-50%"):b=a;if("R"===c||"L"===c||"X"===c)b.style.top=-e+"px";switch(c){case "R":b.style.left=f+h+"px";break;case "L":b.style.right=f+h+"px";break;case "T":b.style.top=-f-h-d+"px";break;case "B":b.style.top=f+h+"px"}this.div_.appendChild(b)};
